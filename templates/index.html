<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Pragma" content="no-store">
    <meta http-equiv="Cache-Control" content="no-store">
    <meta http-equiv="Expires" content="0">
    <title>Number Place</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        margin: 0;
        padding: 10px;
        font-family: sans-serif;
      }

      .table-wrapper {
        position: relative;
        width: 100%;
        max-width: 800px;
        margin: 50px auto;
        border-radius: 12px;
        overflow: hidden;
      }
      .background-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('/static/BackGround2.png');
        background-size: cover;
        background-position: center;
        opacity: 0.3; /* ← ここで背景を薄く */
        z-index: 0;
      }
      table {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 720px;
        border-collapse: collapse;
        margin: auto;
        background-color: transparent; /* ← 透明にする */
        backdrop-filter: blur(4px);
        border-radius: 8px;
      }
      th, td {
        padding: 8px;
        text-align: center;
        word-break: break-word;
        border-bottom: 1px solid #ccc;
        color: #333;
      }
      th {
        color: #555555;
        background-color: transparent; /* ← 透明にする */      }
      td {
        background-color: transparent; /* ← 透明にする */
      }
      input {
        padding: 10px;
        font-size: 16px;
        color: #333;
        background-color: #DDEEFF;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        min-width: 240px;
        max-width: 300px;
      }
      /* コンテナのスタイル */
      .centered-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin: 20px auto;
      }
      /* カスタムラベルのスタイル */
      #customLabel {
        display: inline-block;
        padding: 10px;
        font-size: 16px;
        color: #333;
        background-color: #DDEEFF;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        min-width: 240px;
        max-width: 300px;
      }
      canvas {
        display: block;
        max-width: 100%;
        height: auto;
        margin: 20px auto;
        border: 1px solid #ccc;
        background: #fafafa;
        border: none;
      }
      @media (max-width: 600px) {
        table, thead, tbody, th, td, tr {
          display: block;
          width: 100%;
        }
        th, td {
          box-sizing: border-box;
          width: 100%;
          display: block;
        }
        tr {
          margin-bottom: 10px;
        }
        input {
          width: 100%;
          min-width: 240px;
          max-width: 300x;
        }
        canvas {
          width: 100vw !important;
          max-width: 100vw;
          height: auto !important;
        }
      }

    </style>
</head>
<body>
  <div class="background-layer"></div>
  <div class="table-wrapper">
    <table>
      <tr>
        <th>Number Place</th>
      </tr>
      <form id="index" action="" method="post">
        <tr>
          <td>
            <div class="centered-container">	
              <input type="submit" name="process" value="手入力">
            </div>
          </td>
        </tr>
      </form>
      <form action="" method="post">
        <tr>
          <td>
            <div class="centered-container">			
              <label for="npimage" id="customLabel">
                画像入力
              </label>
              <input type="file" id="npimage" capture="environment" accept="image/*" style="display:none;">			
            </div>
          </td>
        </tr>
      </form>
    </table>
  </div>
  
  <canvas id="canvas" width="400" height="400"></canvas>
	
	<script>
    var form = document.getElementById('index');

    window.addEventListener('pageshow', function (event) {
      // JavaScriptで追加された hidden input を削除
      const hiddenInputs = form.querySelectorAll('input[type="hidden"]');
      hiddenInputs.forEach(input => {
        if (input.dataset.dynamic === 'true') {
          input.remove();
        }
      });
    });

		const label = document.getElementById('customLabel');

		if (navigator.userAgentData) {
			if (navigator.userAgentData.mobile) {
				label.textContent = '画像入力（カメラ撮影）';
				console.log("Mobile device detected (userAgentData)");
				// スマホ向け処理
			} else {
				 label.textContent = '画像入力（ファイル選択）';
				console.log("Desktop device detected (userAgentData)");
				// PC向け処理
			}
		}
		else if (/Mobile|Android|iPhone|iPad/i.test(navigator.userAgent)) {
			label.textContent = '画像入力（カメラ撮影）';
			console.log("Mobile device detected (userAgent)");
			// スマホ向け処理
		} else {
			label.textContent = '画像入力（ファイル選択）';
			console.log("Desktop device detected (userAgent)");
			// PC向け処理
		}

    const canvas = document.getElementById('canvas');
		const context = canvas.getContext('2d');

		form.method = 'POST';
		form.action = '';

    var hiddenInput = document.createElement('input');
		// input要素
		const fileInput = document.getElementById('npimage');

		var img = new Image();

		// changeイベントで呼び出す関数
		const handleFileSelect = () => {
			const files = fileInput.files;
			for (let i = 0; i < files.length; i++) {
				console.log(files[i]); // 1つ1つのファイルデータはfiles[i]で取得できる
			}
			let reader = new FileReader();
			reader.readAsDataURL(files[0]);		
			reader.onload = () => {
				img.src = reader.result;
			}
		}
		img.onload = function(){			
			// 元画像サイズ
			const imgWidth = img.width;
			const imgHeight = img.height;
			const maxLen = Math.max(imgWidth, imgHeight);

			// 長辺が800を超えないようにcanvasサイズを調整
			let scale = 1;
			if (maxLen > 800) {
				scale = 800 / maxLen;
			}
			canvas.width = Math.round(imgWidth * scale);
			canvas.height = Math.round(imgHeight * scale);

			context.drawImage(img, 0, 0, canvas.width, canvas.height);
			const base64_img = canvas.toDataURL("image/jpeg");

      const request = document.createElement('input');
      request.type = 'hidden'; //入力フォームが表示されないように
      request.name = 'image';
      request.value = base64_img;
      request.dataset.dynamic = 'true';
			form.appendChild(request);

      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden'; //入力フォームが表示されないように
      hiddenInput.name = 'process'; 
      hiddenInput.value = '画像入力';
      hiddenInput.dataset.dynamic = 'true';
      form.appendChild(hiddenInput);

			document.body.appendChild(form);

			form.submit();
		}
		// ファイル選択時にhandleFileSelectを発火
		fileInput.addEventListener('change', handleFileSelect);
	</script>

</body>
</html>